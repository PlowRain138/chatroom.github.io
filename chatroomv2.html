<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>SL</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

     <!--Reference the SignalR library. -->
    <script src="https://pi.rocket-coding.com/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <!--Reference the autoGenerated SignalR hub script. -->
    <script src="https://pi.rocket-coding.com/signalr/hubs"></script>

    <script type="text/javascript">

        function hubConnect() {
            //連線後台hub
            $.connection.hub.url = 'https://pi.rocket-coding.com/signalr';
            chat = $.connection.chartHubb;
            console.info(chat);

            //刷新ICON未讀訊息 如果收到訊息但沒有點及ICON狀態下的話 ，使用這個function
            chat.client.showIconUnRead = function () {
                //if( icon為被點即狀態的話) icon.picture = unRead.jpg;
                //其他返回ICON圖案的時候都是 icon.picture = read.jpg
            }
            //刷新聊天室的訊息
            chat.client.showLastMsg = function () {
            
                var myNumber = document.getElementById("myNumber").value;
                var myType = document.getElementById("myType").value;
                console.log("halo");
                const test = async () => {
                try {
                    //這裡要改API參數 
                    //1.ID
                    //2.是user OR counselor
              
                    const res = await axios.get('https://pi.rocket-coding.com/api/chatroom/lastMsgTarget?Id=' + myNumber + '&Type=' + myType);
                    console.log("myNumber = " + myNumber  +" myType  = " + myType);
                    
                    //渲染畫面
                    $('#user-list-group').html('');
                    for (var i = 0; i < res.data.Data.userChatTargetList.length; i++) {
                        var read = "未讀*";
                        if (myType == 'user') {    
                            var id = res.data.Data.userChatTargetList[i].CounselorId;
                            //if (res.data.Data.userChatTargetList[i].UserRead) read = "已讀";
                        }
                        else {
                            var id = res.data.Data.userChatTargetList[i].UserId;
                            //if (res.data.Data.userChatTargetList[i].CounselorRead) read = "已讀";
                        }
                        
                        var mhtml = '<button type="button" class="list-group-item" title="' + id
                            + '" onclick="listGroupItemClick(this);" >' + res.data.Data.userChatTargetList[i].OutName + '</button>' + "<p>" + read+ " 最後一句內容 " + res.data.Data.userChatTargetList[i].Content+"</p>";
                        $('#user-list-group').append(mhtml);
                    }
                    console.log(res);
                } catch (error) {
                    console.log(error)
                }
            }
            test();
            }

            //顯示訊息的地方 Method 
            chat.client.showMessage = function (id, message) {
                var msg = '';
                var myNumberID = document.getElementById("myNumber").value;
                var myType = document.getElementById("myType").value;
                var outId = $('#sid').text();
                //console.log("myNumberID = " + myNumberID + "  outId = " + outId + " id = " + id);
                //渲染畫面
                if (myNumberID == id && userType == myType) {
                    msg = '<p><span class="label label-success"> 我 </span>' + message + '</p>';
                }
                else {
                    if (outId == id)
                        msg = '<p><span class="label label-info"> 對方 </span>' + message + '</p>';
                }
                $('#contextDIV').append(msg);
                $('#message').val('');
                $('#message').val('').focus();
            }   //end showMessage   //end showMessage

            //發送按鈕
            $('#sendmessage').click(function () {
                var outid = $('#sid').text();
                var outmessage = $('#message').val();
                var myNumberID = document.getElementById("myNumber").value;

                if (outid != '' && outmessage != '') {
                    var myType = document.getElementById("myType").value;
                    var sendType = '';
                    //判斷是諮商師還是USER
                    if (myType == 'user')
                    {
                        sendType = 'send';
                    }
                    else
                    {
                        sendType = 'accept';
                        var index = outid;
                        outid = myNumberID;
                        myNumberID = index;
                    }

                    const data = {
                        "CounselorId":outid,
                        "UserId": myNumberID,
                        "Type": sendType,
                        "Content": outmessage
                    }; // 填入需要發送的資料
                    axios.post('https://pi.rocket-coding.com/api/chatroom/chatlogs', data)
                        .then((response) => {
                            console.log('回應：', response);
                        })
                        .catch((error) => {
                            console.error('錯誤：', error);
                        });

                    if (myType == 'user') {
                        chat.server.sendTo(outid, outmessage, myType);
                    }
                    else {
                        chat.server.sendTo(myNumberID, outmessage, myType);
                    }
                    
                }
                else {
                    alert('請選擇目標以及內容');
                }

            });  //end click

            //當連線成功,註冊
            $.connection.hub.start().done(function () {
                var myNumber = document.getElementById("myNumber").value;
                var myType = document.getElementById("myType").value;
                chat.server.setUserId(myNumber);
               
            });
        };   //end page ready


        //聊天對象點擊之後，刷新聊天室內容
        function listGroupItemClick(that) {
            var myNumberID = document.getElementById("myNumber").value;
            var tid = $(that).attr('title');
            $('#contextDIV').html('');
            $('#sid').text(tid);
            var myType = document.getElementById("myType").value;
            if (myType == 'counselor') {
                var index = myNumberID;
                var myNumberID = tid;
                var tid = index;
            }
          
            const test = async () => {
                try {
                    const res = await axios.get('https://pi.rocket-coding.com/api/chatroom/GetChatlogs?CounselorId=' + tid + '&UserId=' + myNumberID + '&UserType='+myType);
                    console.log(res.data.Data.ChatlogList);
                    //渲染畫面
                    for (var i = 0; i < res.data.Data.ChatlogList.length; i++) {
                        if ((res.data.Data.ChatlogList[i].Type == 'accept' && myType == 'counselor') || (res.data.Data.ChatlogList[i].Type == 'send' && myType == 'user')) {
                            msg = '<p><span class="label label-success">  我 </span>' + res.data.Data.ChatlogList[i].Content + '</p>';
                        }
                        else {
                            msg = '<p><span class="label label-info"> 對方</span>' + res.data.Data.ChatlogList[i].Content + '</p>';
                        }
                        $('#contextDIV').append(msg);

                    }
                } catch (error) {
                    console.log(error)
                }
            }
            test();

         //end listGroupItemClick
        }

        // 按下enter=按下按鈕發送訊息
        $(document).keydown(function () {
            if (event.keyCode == 13) {
                $('#sendmessage').click();
            }
        });  //end keydown



        //按下按鈕(ICON)出現聊天對象
        function getTarget() {
            var myNumber = document.getElementById("myNumber").value;
            var myType = document.getElementById("myType").value;
            $("#curUserType").text(myType);
            $("#curUserId").text(myNumber); 
 
            const test = async () => {
                try {
                    //這裡要改API參數 
                    //1.ID
                    //2.是user OR counselor
                    
                    const res = await axios.get('https://pi.rocket-coding.com/api/chatroom/lastMsgTarget?Id=' + myNumber + '&Type=' + myType);
                    console.log("myNumber = " + myNumber  +" myType  = " + myType);
                    
                    //渲染畫面
                    $('#user-list-group').html('');
                    for (var i = 0; i < res.data.Data.userChatTargetList.length; i++) {
                        var read = "未讀*";
                        
                        
                        if (myType == 'user') {    
                            var id = res.data.Data.userChatTargetList[i].CounselorId;
                            //if (res.data.Data.userChatTargetList[i].UserRead) read = "已讀";
                        }
                        else {
                            var id = res.data.Data.userChatTargetList[i].UserId;
                            //if (res.data.Data.userChatTargetList[i].CounselorRead) read = "已讀";
                        }
                        
                        var mhtml = '<button type="button" class="list-group-item" title="' + id
                            + '" onclick="listGroupItemClick(this);" >' + res.data.Data.userChatTargetList[i].OutName + '</button>' + "<p>" + read+ " 最後一句內容 " + res.data.Data.userChatTargetList[i].Content+"</p>";
                        $('#user-list-group').append(mhtml);
                    }
                    console.log(res);
                } catch (error) {
                    console.log(error)
                }
            }
            test();
        }//end listGroupItemClick

        //增加諮商師到USER的聊天室框框內
        function addTarget(that) {
            var tname = $(that).text();
            var tid = $(that).attr('title');
          
            //畫面選染
            var mhtml = '<button type="button" class="list-group-item" title="' + tid
                + '" onclick="listGroupItemClick(this);" >' + tname + '</button>';
            var element = document.getElementById('user-list-group');
            var childNodes = element.childNodes;
            var isHaveTarget = false;

          
            //判斷是否增加過了
            for (var i = 0; i < childNodes.length; i++) {
                if (childNodes[i].title == tid) {
                    isHaveTarget = true;
                    console.log('測試' + childNodes[i].textContent);
                }
            }
            if (isHaveTarget == false) $('#user-list-group').append(mhtml);
            
        }

        //得到所有諮商師的目標 ID 這段可以不要
        function getCounselor() {
            var myType = document.getElementById("myType").value;
            if (myType != "user") return;
            const test = async () => {
                try {
                    //這裡要改API參數 1.ID 2. 是user OR counselor
                    const res = await axios.get('https://pi.rocket-coding.com/api/chatroom/getTatgetCounselor');
                    $('#btn').html('');
                    for (var i = 0; i < res.data.Data.counselorList.length; i++) {
                        console.log("258" + res.data.Data.counselorList[i].Name);
                        var mhtml = '<button type="button" class="list-group-item" title="' + res.data.Data.counselorList[i].Id
                            + '" onclick="addTarget(this);" >' + res.data.Data.counselorList[i].Name + '</button>';
                        $('#btn').append(mhtml);
                    }

                  
                } catch (error) {
                    console.log(error)
                }
            }
            test();
     
        }
    </script>

</head>
<body>
    <button class="col-sm-12" onclick="getTarget()">打開ICON出現曾經聊天過的對象</button>
    <button class="col-sm-12" onclick="getCounselor()" id="btn">點我出現所有諮商師名字</button>
    <button class="col-sm-12" onclick="hubConnect()">點我連線</button>
    <div class="container">
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="well well-sm">
                    <div class="text-center">
                        當前編號：
                        ex: 5
                        <input type="number" id="myNumber">
                        <span id="curUserId"></span>
                        <br />
                        用戶類型：
                        user or counselor
                        <input id="myType">
                        <span id="curUserType"></span>
                        <br />
                        1.先輸入編號<br /> 2.輸入當前用戶類型  <br />3.連線跟點下ICON
                    </div>

                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2 col-sm-4">
                <div id="user-list-group" class="list-group">
                    
                </div>
                <!--hiden value-->
                <div style="display:none;">
                    <input type="text" id="userName" name="userName" />
                </div>
            </div>  <!--end left-->

            <div class="col-md-10 col-sm-8">
                <div class="row">
                    <!--CHART text-->
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            對話框：
                            <span id="sname"></span>
                            【<span id="sid"></span>】
                        </div>

                        <div class="panel-body">
                            <div id="contextDIV" style="height:500px;overflow:auto;">
                                
                            </div>
                        </div> <!--end panel body-->

                        <div class="panel-footer">
                            <div class="row">
                                <div class="col-md-12 col-sm-12">
                                    <div class="input-group">
                                        <input type="text" id="message" name="message" class="form-control" />
                                        <span class="input-group-btn">
                                            <input type="button" class="btn btn-default" id="sendmessage" name="sendmessage" value="發送" />
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div><!--end pannel foot-->

                    </div> <!--end pannel-->
                </div>
            </div>  <!--end right-->
        </div>

    </div>
</body>
</html>